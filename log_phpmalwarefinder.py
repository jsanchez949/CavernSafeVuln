# coding=utf-8
import os
import re
import pandas as pd

def ejecutar_log():
    # Comprobar si existe la direcci√≥n /home/kali/Desktop/Herramientas/php-malware-finder/php-malware-finder/phpmalwarefinder
    # Si no existe, clonar el repositorio dentro de la carpeta Herramientas en el escritorio
    if not os.path.exists('/home/kali/Desktop/Herramientas/php-malware-finder/php-malware-finder/phpmalwarefinder'):
        os.system('git clone https://github.com/nbs-system/php-malware-finder.git /home/kali/Desktop/Herramientas/php-malware-finder/')
        os.system('chmod 755 -R /home/kali/Desktop/Herramientas/php-malware-finder/')
        if not os.path.exists('/home/kali/Desktop/Herramientas/php-malware-finder/php-malware-finder/phpmalwarefinder'):
            print("No se pudo clonar el repositorio.")
            exit()

    # Ejecutar la herramienta
    print("--------- Inicio de la herramienta PHP_Malware_Finder ----------")
    ejecucion = "/home/kali/Desktop/Herramientas/php-malware-finder/php-malware-finder/phpmalwarefinder ."

    # Ejecuta el comando del sistema y obtiene la salida como un flujo de datos
    output = os.popen(ejecucion).read()
    print(ejecucion)

    # Crea un patr√≥n para buscar l√≠neas que contengan el texto "resultado"
    pattern = re.compile(r'.php|module')

    # Crear un DataFrame para almacenar los datos
    df = pd.DataFrame(columns=['Resultado'])

    # Itera sobre las l√≠neas de la salida del comando
    for line in output.splitlines():

        # Si la l√≠nea coincide con el patr√≥n, a√±√°dela al DataFrame
        match = pattern.search(line)
        if match:
            cleaned = re.sub("\[\w+m", "", line)
            cleaned_row = cleaned.replace("", "")
            df = df.append(pd.Series([cleaned_row]), ignore_index=True)
            print(cleaned_row)

    # Guardar el DataFrame en un archivo csv
    df.to_csv('resultados/resultados_php_mf.csv', index=False)
